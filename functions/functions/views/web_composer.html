<!DOCTYPE html>
<html>
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

     <!-- Bootstrap CSS -->
     <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css">     
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
     <link rel="stylesheet" href="/vendor/colorPicker/css/bootstrap-colorpicker.css">
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
     <link rel='icon' href='https://vigil.com.ar/favicons/notimation.ico' type='image/x-icon' />
     <link rel="stylesheet" href="/vendor/grapick/grapick.min.css">
     <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.7/css/all.css">

     <title>Noti.ms</title>
  
      <style>  
    
        .column-background {
          background-color: #fff; border-radius: 5px; padding: 20px; 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
        }

        .droppable-active { background-color: #ffe !important; }
        .tools a { cursor: pointer; font-size: 80%; }
        .form-body .col-md-6, .form-body .col-md-12 { min-height: 800px; }
        .draggable { cursor: move; }

        hr {
          margin-top: 1rem;
          margin-bottom: 1rem;
          border: 0;
          border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .checkbox {
          padding-left: 10px;
          padding-right: 10px;
        }
        
        .form-composer {
          padding-left:15px;
        }        
      
     </style>
     <link rel="stylesheet" type="text/css" href="/css/styles_uitool.css">

  </head>

  <body class="body_web_composer">       
     
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>    
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>        
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" defer></script>
    <script src="https://cdn.tiny.cloud/1/lr9wasio09vwo6la4k91gs8hybva1vp7oxw5k9cfpm2g5pm6/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>        
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>            
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-functions.js"></script>   

    
    <script src="/vendor/grapick/grapick.min.js"></script>

    <script src="https://kit.fontawesome.com/f014efefd7.js" crossorigin="anonymous"></script>
    <script src="/vendor/colorPicker/js/bootstrap-colorpicker.js"></script>

    <header>
      <img class="logo_ui" src="/images/uitool_logo.png">
      <div class="info_user">
        <button type="button" class="btn btn_acerca" data-toggle="modal" data-target="#acercaModal"><i class="fas fa-info-circle"></i> Acerca</button>
        <button class="btn btn_loguot"><i class="fas fa-sign-out-alt"></i> Salir</button>
        <div class="powered">
          <span class="badge badge-default">powered by</span>
          <a href="http://notimation.com.ar/"><img alt="Bootstrap Image Preview"src="/images/logo_noti.png" /></a>
        </div>
      </div>            
    </header>
    <div class="uilinea"></div> 
    <section>
    <div class="section_title mb-3">
      <h3>Diseñador de campañas</h3>
      <div class="info_clie">
        <span class="pr-3">Juan Perez</span>
        <button id="save-design" type="button" class="btn btn_ui_grey">Guardar Diseño</button>
        <div id="spinner-save" class="spinner-border d-none" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>        
    </div>
    <div class="container-fluid">

      <!-- <div class="row">
        <div id="login" class="pt-1 pl-4 pr-2">
          Web Composer - Not Logged 
        </div>  
        <div id="save" class="pt-1 pl-2">    
            Not saved     Es aca 
        </div> 
      </div> --> 
      
      <div class="row">
        <div class="col-md-3">

          <div id="html-preview" class="column-background">

            <ul class="nav nav-tabs nav-fill" role="tablist">
              
              <li class="nav-item">
                <a class="nav-link  active" href="#apreview" role="tab" onclick="window.LoadPreview()" data-toggle="tab" aria-selected="true">Imagen</a>
              </li>

              <li class="nav-item">
                <a class="nav-link" href="#amessage" role="tab" onclick="window.LoadMessage()" data-toggle="tab" aria-selected="true">Texto</a>
              </li>
              
              <li class="nav-item">
                <a class="nav-link" href="#aweb" role="tab" onclick="window.LoadWeb()" data-toggle="tab">Web</a>
              </li>              

            </ul>            
            
            <div class="tab-content">
              
              <div role="tabpanel" class="tab-pane active" id="apreview">

                <form id="form-composer-preview" role="form">
                    
                  <br>

                  <div id="ori-llamada" class="form-group draggable">
                    <label for="ori-for-llamada" ><b>Llamada a la acción</b></label>
                    <input type="text" class="form-control" id="ori-inllamada">
                    <p class="help-block">Crear llamada a la acción</p>
                  </div>

                  <div id="ori-subtitulo" class="form-group draggable">
                    <label for="ori-for-subtitulo" ><b>Subtitulo</b></label>
                    <input type="text" class="form-control" id="ori-insubtitulo">
                    <p class="help-block">Subtitulo</p>
                  </div>

                  <div id="ori-mensaje" class="form-group draggable">
                    <label for="ori-for-mensaje" ><b>Mensaje</b></label>  
                    <input id="ori-inmensaje" type="text" class="form-control">
                    <p>Crea el mensaje</p>                        
                  </div>

                  <div id="ori-color-preview" class="form-group draggable">
                    <label for="ori-for-color-preview" ><b>Color de fondo</b></label>                   
                    <div class="grapick-cont">
                      <div id="ori-grapick"></div>                      
                      <div id="ori-grapick-inputs" class="row grapick-inputs d-none">

                        <select class="form-control" id="ori-switch-type">
                          <option value="">- Select Type -</option>
                          <option value="radial">Radial</option>
                          <option value="linear">Linear</option>
                          <option value="repeating-radial">Repeating Radial</option>
                          <option value="repeating-linear">Repeating Linear</option>
                        </select>
            
                        <select class="form-control" id="ori-switch-angle">
                          <option value="">- Select Direction -</option>
                          <option value="top">Top</option>
                          <option value="right">Right</option>
                          <option value="center">Center</option>
                          <option value="bottom">Bottom</option>
                          <option value="left">Left</option>
                        </select>
                        
                      </div>                      
                  </div>
                  <p class="help-block">Cambiar color de fondo</p>                    
                  </div>

                  <div id="ori-imagen-preview" class="form-group draggable">
                    <label for="ori-for-imagen-preview" ><b>Imagen</b></label>
                    <input id="ori-inimagen-preview" type="file" name="files[]">
                    <p class="help-block">Agregar imagen</p>
                  </div>

                  <div id="ori-fondo" class="form-group draggable">
                    <label for="ori-for-fondo" ><b>Imagen de fondo</b></label>                                            
                    <input id="ori-infondo" type="file" accept=".jpg, .jpeg, .png">
                  </div>

                  <div id="ori-pie" class="form-group draggable">
                    <label for="ori-for-pie" ><b>Pie de preview</b></label>
                    <div class="control-group">                        
                      <div class="controls span2">
                          <label class="checkbox">
                            <input type="checkbox" id="ori-inInfo"> + info
                          </label>
                          <label class="checkbox">
                              <input type="checkbox" id="ori-inDescuento"> Descuento
                          </label>
                          <label class="checkbox">
                              <input type="checkbox" id="ori-inReclamar"> Reclamar
                          </label>
                          <label class="checkbox">
                              <input type="checkbox" id="ori-inContactar"> Contactar
                          </label>                            
                      </div>                        
                    </div>
                    <p class="help-block">Pie de preview</p>
                  </div>                
                  
                  <!--<div id="ori-color-preview" class="form-group draggable">
                    <label for="ori-for-color-preview" ><b>Color de fondo</b></label>                   
                    <input type="text" value="rgb(0, 0, 0)" />
                    <p class="help-block">Cambiar color de fondo</p>                    
                  </div>-->                 

                </form>

              </div>

              <div role="tabpanel" class="tab-pane fade" id="amessage">

                <form id="form-composer-message" role="form">
                    
                  <br>                                

                  <div id="ori-text" class="form-group draggable">
                    <label for="ori-for-text" ><b>Testo del Mensaje</b></label>  
                    <input id="ori-intexto" type="text" class="form-control">
                    <p>Crea el texto del mensaje</p>                        
                  </div>                 

                </form>

              </div>
              
              <div role="tabpanel" class="tab-pane fade" id="aweb">

                <form id="form-composer-web" role="form">
                    
                  <br>

                  <div id="ori-saludo" class="form-group draggable">
                    <label for="ori-for-saludo" ><b>Saludo</b></label>
                    <input type="text" class="form-control" id="ori-insaludo">
                    <p class="help-block">Saludo de cortecia</p>
                  </div>
                  
                  <div id="ori-cuerpo" class="form-group draggable">
                    <label for="ori-for-cuerpo" ><b>Cuerpo</b></label>  
                    <input type="text" class="form-control">
                    <p>Crea el cuerpo del mensaje</p>                        
                  </div>                    
                  

                  <div id="ori-contacto" class="form-group draggable">
                    <label for="ori-for-contacto" ><b>Contacto</b></label>
                    <div class="control-group">                        
                      <div class="controls span2">
                          <label class="checkbox">
                            <input type="checkbox" id="ori-inGrabar"> Grabar mensaje
                          </label>
                          <label class="checkbox">
                              <input type="checkbox" id="ori-inLlamar"> Llamame
                          </label>
                          <label class="checkbox">
                              <input type="checkbox" id="ori-inWhatsapp"> Whatsapp
                          </label>
                          <label class="checkbox">
                              <input type="checkbox" id="ori-inEmail"> Email
                          </label>                            
                      </div>                        
                    </div>
                    <p class="help-block">Modo de contacto</p>
                  </div>

                  <div id="ori-pagos" class="form-group draggable">
                    <label for="ori-for-pagos" ><b>Pagos</b></label>
                    <input type="text" class="form-control" id="ori-inpagos">
                    <div class="control-group">                        
                      <div class="controls">
                          <div class="row">
                            <label class="checkbox">
                                <input type="checkbox" id="ori-inMercado"> Mercadopago
                            </label>                              
                            <label class="checkbox">
                                <input type="checkbox" id="ori-inRapi"> Rapipago
                            </label>
                          </div>
                          <div class="row">
                            <label class="checkbox">
                                <input type="checkbox" id="ori-inFacil"> Pago Facil
                            </label>
                            <label class="checkbox">
                              <input type="checkbox" id="ori-inOtros"> Otros
                            </label>           
                          </div>                   
                      </div>                        
                      </div>                                                          
                      <p class="help-block">Medio de pago</p>
                  </div>  

                  <div id="ori-facturas" class="form-group draggable">
                    <label for="ori-for-facturas" ><b>Detalle de facturas</b></label>
                    <input type="text" class="form-control" id="ori-infacturas">
                    <div class="control-group">                        
                      <div class="controls">
                          <div class="row">                                                           
                            <label class="checkbox">
                              <input type="checkbox" id="ori-inMonto"> Monto
                            </label> 
                            <label class="checkbox">
                              <input type="checkbox" id="ori-inDetalle"> Ver detalle
                            </label>
                            <label class="checkbox">
                                <input type="checkbox" id="ori-inDescargar"> Descargar PDF
                            </label>                                                            
                          </div>                                             
                        </div>                        
                      </div>                                                          
                      <p class="help-block">Detalle de facturas</p>
                  </div>  
                  
                  <div id="ori-imagen-web" class="form-group draggable">
                    <label for="ori-for-imagen-web" ><b>Imagen</b></label>
                    <input id="ori-inimagen-web" type="file" name="files[]">
                    <p class="help-block">Agregar imagen</p>
                  </div>

                  <div id="ori-color-web" class="form-group draggable">
                    <label for="ori-for-color-web" ><b>Color de fondo</b></label>                   
                    <input type="text" value="rgb(0, 0, 0)" />
                    <p class="help-block">Cambiar color de fondo</p>                    
                  </div>
                
                </form>

              </div>              

            </div> 
            
          </div> 
          
          
        </div>
        <div class="col-md-5">

          <div class="column-background" style="font-size: 15px;">
            <label>Arrastrar y soltar elementos en los campos.</label>
            <div class="row" id="composer"></div>
            <hr/>
            <div id="drop-body" class="row form-body">
              <div id="drop-area" class="col-md-12 droppable sortable">
              </div>              
            </div>
          </div>
          
        </div>       
        <div class="col-md-4">
          <div class="column-background">
            <div class="form-group draggable">
              <div class="pb-2" id="preview-preview">             
              </div>
              <div class="pb-2" id="preview-message">             
              </div>
              <div class="pt-2" id="preview-web">             
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Alert -->  
      <div id="alertModal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">                                
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <p id="alert-content"></p>
                </div>                                
                <div data-dismiss="modal" class="modal-footer"><button type="button" class="btn btn-primary">OK</button></div>
            </div>
        </div>
      </div>
     
    </div>
    </section>
    <div class="uilinea mt-3"></div>
    <footer>
      <div class="powered">
        <span class="badge badge-default">powered by</span>
        <a href="http://notimation.com.ar/"><img alt="Bootstrap Image Preview"src="/images/logo_noti.png" /></a>
      </div>
    </footer>

    <style>

    .grapick-cont {
      /*box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);*/
      border-radius: 3px;
      margin: -15px;
      padding: 15px 15px;
      width: 100%;
      min-height: 80px;
      background: rgb(255, 255, 255);
    }

    #ori-grapick {      
      border-radius: 3px;
      margin: -5px;
      padding: 5px 5px;
      width: 100%;
      min-height: 50px;
      background: rgb(255, 0, 0);
    }

    .grp-preview {
      border-radius: 3px;
    }

    .grp-wrapper {
      height: 40px !important;
    }

    .grapick-inputs {
      margin: 25px 0px 15px;
    }

    .form-control {
      background-color: transparent;
      border: 1px solid #ccc;
      border-radius: 3px;
      height: 30px;
      width: 49%;
    }
    </style>

    <script>  


    $(document).ready(function () {          

      var timer_save = null;

      var InitActive = function() {
        active = {
          saludo : false,
          cuerpo : false,
          from_button : false,
          facturas : false,
          llamada : false,
          subtitulo : false,
          mensaje : false
        };
      };

      var active;
      InitActive();

      var target_result;

      var data;
      var count_drop = 0;

      var noti_html;

      const firebaseConfig = {
        apiKey: "AIzaSyAM4WQDHpHh1oRT_v-6ikquE4V809hA3kY",
        authDomain: "notims.firebaseapp.com",
        databaseURL: "https://notims.firebaseio.com",
        projectId: "notims",
        storageBucket: "notims.appspot.com",
        messagingSenderId: "79471870593",
        appId: "1:79471870593:web:ef29a72e1b1866b2bb4380",
        measurementId: "G-8T5N81L78J"
      };
      var fireApp   = firebase.initializeApp(firebaseConfig);
      var fireAuth  = fireApp.auth();   
      var firestore = firebase.firestore();   

      var getUrlParameter = function getUrlParameter(sParam) {
          var sPageURL = window.location.search.substring(1),
              sURLVariables = sPageURL.split('&'),
              sParameterName,
              i;

          for (i = 0; i < sURLVariables.length; i++) {
              sParameterName = sURLVariables[i].split('=');

              if (sParameterName[0] === sParam) {
                  return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
              }
          }
      };        
      
      window.LoadPreview = function() {  
        window.type = "preview";
        updateType();
        if (tinymce.activeEditor) {                  
          tinymce.activeEditor.destroy();
        }
        $("#preview-preview").empty();               
        $("#drop-area").empty();               
        count_drop=0;        
        InitActive();        
        LoadTypes(window.docDesign);
      }

      window.LoadMessage = function() {     
        window.type = "message";
        updateType();
        if (tinymce.activeEditor) {                  
          tinymce.activeEditor.destroy();
        }            
        $("#preview-message").empty();
        $("#drop-area").empty();   
        count_drop=0;
        InitActive();
        LoadTypes(window.docDesign);
      }

      window.LoadWeb = function() {             
        window.type = "web";
        updateType();
        if (tinymce.activeEditor) {                  
          tinymce.activeEditor.destroy();
        }            
        $("#preview-web").empty();        
        $("#drop-area").empty();   
        count_drop=0;        
        InitActive();
        LoadTypes(window.docDesign);
      }

      window.RemoveElement = function(removeId) {
        let id = "#" + removeId;
        $(id).remove();        
      }

      function updateType(){
        window.docDesign.ref.collection("designs") 
                .doc(window.designId).set({load_type:window.type},{merge:true});
      }      
    
      $( "#login" ).click(function() {    

        firebase.auth()
        .signInWithEmailAndPassword("josemanuelvigil@gmail.com", "master")
        .then(function(user) {   

            console.log(user.id);
            window.location.reload();     

        }).catch( function(error) {                         
            var errorMessage = error.message;  
            console.log(errorMessage);
        });

      });        
    
      firebase.auth().onAuthStateChanged(async function (user) {

        if (user) { 

          //$("#login").text("Web Composer - Logged");

          window.account = getUrlParameter('account');         
          window.campaignId = getUrlParameter('campaignId');  
          window.designId = getUrlParameter('designId');           

          window.documentPath = `accounts/${window.account}/campaigns/${window.campaignId}`; ///web/sample`;

          let designPath = window.documentPath + "/designs/" + window.designId;

          let docDesign = await firestore.doc(designPath).get();
          window.type   = docDesign.data().load_type;
          
          firestore.doc(window.documentPath).get()
              .then(function(doc) {   

                // LOAD FIELDS
                
                if (doc.exists) {

                  var name =  doc.data().name;                
                  var fields =  doc.data().fields;                                     

                  let json = `{`;

                  var count = 0;
                  var length = fields.length;
                  
                  for (var i=0; i<length; i++) {

                      let field = fields[i];                      
                      let name = field.name;
                      let value = field.value;

                      var button;
                      switch (i) {
                        case 0:
                          button = "btn-primary";
                        break;
                        case 1:
                          button = "btn-secondary";
                        break;
                        case 2:
                          button = "btn-success";
                        break;
                        case 3:
                          button = "btn-warning";
                        break;
                        case 4:
                          button = "btn-info";
                        break;
                        default:
                          button = "btn-dark";
                          break;
                      }

                      json += ` "${name}" :  { 
                          "datos" : "${value}", 
                          "boton" : "${button}"
                      }`;

                      if (count === (length-1)) {
                        json += `}`;
                      } else {
                        json += `,`;
                      }
                      count++;
                  } 

                  data = JSON.parse(json);     

                  // CLICK FIELD BUTTONS       

                  for (var key of Object.keys(data)) {
                    
                    let nombre = key;
                    let datos = data[key]["datos"];
                    let boton = data[key]["boton"];

                    let _html = `&nbsp;&nbsp<button data-field="${datos}" style="color:white" class="botones btn ${boton}" type="button" id="${nombre}">${nombre}</button>&nbsp;&nbsp`;
              
                    $("#composer").append(_html);

                    $("#" + nombre).on('click', function (e) {                     
                      
                      e.preventDefault();
                      active.from_button = true;

                      var timer_click = setTimeout(function() {                                                           
                      
                        var id = $(e.target).attr('id'); 
                        var variable;
                        variable = "{" + nombre + "}";  

                        if ( type === "web" ) {                    

                            if (active.saludo) {

                              let cursorPos = $('#insaludo').prop('selectionStart');
                              let v = $('#insaludo').val();
                              let textBefore = v.substring(0,  cursorPos );
                              let textAfter  = v.substring( cursorPos, v.length );
                              $('#insaludo').val( textBefore + variable + textAfter ); 

                            } else if (active.cuerpo) {                
                            
                              tinymce.activeEditor.execCommand('mceInsertContent', false, variable);
                            
                            } else if (active.facturas) {

                              let cursorPos = $('#infacturas').prop('selectionStart');
                              let v = $('#infacturas').val();
                              let textBefore = v.substring(0,  cursorPos );
                              let textAfter  = v.substring( cursorPos, v.length );
                              $('#infacturas').val( textBefore + variable + textAfter ); 

                            }

                        } else if ( type === "message" ) {

                            tinymce.activeEditor.execCommand('mceInsertContent', false, variable);

                        } else if ( type === "preview" ) {

                          if (active.llamada) {

                            let cursorPos = $('#inllamada').prop('selectionStart');
                            let v = $('#inllamada').val();
                            let textBefore = v.substring(0,  cursorPos );
                            let textAfter  = v.substring( cursorPos, v.length );
                            $('#inllamada').val( textBefore + variable + textAfter ); 

                          } else if (active.subtitulo) {   

                            let cursorPos = $('#insubtitulo').prop('selectionStart');
                            let v = $('#insubtitulo').val();
                            let textBefore = v.substring(0,  cursorPos );
                            let textAfter  = v.substring( cursorPos, v.length );
                            $('#insubtitulo').val( textBefore + variable + textAfter ); 

                          } else if (active.mensaje) {                

                              tinymce.activeEditor.execCommand('mceInsertContent', false, variable);
                          }

                        } 

                        clearTimeout(timer_click);

                      }, 200);

                    });
                  }

                  // LOAD WEB OR PREVIWE FROM PARAMS

                  window.docDesign = doc;                  

                  var atimer = setTimeout(function() { 

                    if (window.type=="web") {                       
                      $('a[href="#aweb"]').tab('show');
                      window.LoadWeb();
                    } else if (window.type=="message") {            
                      $('a[href="#amessage"]').tab('show');
                      window.LoadMessage();                   
                    } else if (window.type=="preview") {            
                      $('a[href="#apreview"]').tab('show');
                      window.LoadPreview();
                    }

                    clearTimeout(atimer);

                  }, 500);
                                  
              }
          });  

          /////////////////////////////////
          ////////// grapick /////////////
          // https://artf.github.io/grapick/
          // https://github.com/artf/grapick/blob/master/index.html
          /////////////////////////////////

          var upType, unAngle, gp;
          var gradient_color;        
          
          var createGrapick = function() {
            gp = new Grapick({
              el: '#grapick',
              direction: 'right',
              min: 1,
              max: 99,
            });
            gp.addHandler(1, '#085078', 1);
            gp.addHandler(99, '#85D8CE', 1, { keepSelect: 1 });
            gp.on('change', function(complete) {
              const value = gp.getValue();
              gradient_color = value;
              //document.body.style.backgroundImage = value;
              //$(".grp-wrapper").css("backgroundImage", value);              
              GetHTML();
              //copyTxt.value = value;
            });
            gp.on('handler:drag:start', function(drag) {
              const value = gp.getValue();               
            });
            gp.on('handler:drag:end', function(drag) {
              const value = gp.getValue();     
              gradient_color = value;
            });
            gp.emit('change');

            var swType = $('#switch-type');
            var swAngle = $('#switch-angle');

            swType.change(function() {
              gp && gp.setType(this.value || 'linear');
              const value = gp.getValue();
              gradient_color = value;
              GetHTML();
            });

            swAngle.change(function() {
              gp && gp.setDirection(this.value || 'right');
              const value = gp.getValue();
              gradient_color = value;
              GetHTML();
            });

            /*swType.addEventListener('change', function(e) {
              gp && gp.setType(this.value || 'linear');
            });

            swAngle.addEventListener('change', function(e) {
              gp && gp.setDirection(this.value || 'right');
            });*/             


            /*var swType = document.getElementById('switch-type');
            var swAngle = document.getElementById('switch-angle');

            swType.addEventListener('change', function(e) {
              gp && gp.setType(this.value || 'linear');
            });

            swAngle.addEventListener('change', function(e) {
              gp && gp.setDirection(this.value || 'right');
            });*/

          };

          var destroyGrapick = function() {
            gp.destroy();
            gp = 0;
          }

          var copyToClipboard = function(str) {
            var el = document.createElement('textarea');
            el.value = str;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
          };                  
          


          LoadTypes = function(doc) {

            doc.ref.collection("designs") 
                .doc(window.designId).get()
                .then( async function(docWeb) { 

                  if (docWeb.exists) { 

                    window.type =  docWeb.data().load_type; 

                    if (window.type=="preview") {                      
                   
                        let modules_preview = docWeb.data().inputs_preview;
                        if (modules_preview != undefined) { 

                            let background_color_preview = docWeb.data().background_color_preview;

                            var plength = Object.keys(modules_preview).length;
                            
                            if (plength > 0 ) {

                              var flags_preview = [];                                     

                              for ($m in modules_preview) {

                                let module_preview = modules_preview[$m];

                                var $orig, name, flag;

                                switch (module_preview.key) {
                                  case "llamada":
                                    $orig = $("#ori-llamada");                                                                
                                    flag = 1;
                                    break;
                                  case "subtitulo":
                                    $orig = $("#ori-subtitulo");                                                                
                                    flag = 2;
                                    break;
                                  case "mensaje":
                                    $orig = $("#ori-mensaje");                                                                
                                    flag = 3;                                
                                    break;
                                  case "fondo":
                                    $orig = $("#ori-fondo");                                                                
                                    flag = 4;                                
                                    break;
                                  case "pie":
                                    $orig = $("#ori-pie");                                                                
                                    flag = 5;                                
                                    break;
                                  case "imagen-preview":
                                      $orig = $("#ori-imagen-web");                                                                
                                      flag = 6;                                
                                      break;
                                  case "color-preview":
                                    $orig = $("#ori-color-preview");                                                                
                                    flag = 7;                                
                                    break;
                                }

                                name = module_preview.key;

                                var $ele = $orig.clone()
                                  .addClass("dropped")
                                  .css({"position": "static", "left": null, "right": null})                            
                                  .appendTo( "#drop-area" );

                                await drop_element($ele, name, $orig);                        
                                
                                flags_preview[flag] = [module_preview.value, $ele]; 

                              } 
                          
                              for (flag in flags_preview) { 
                                
                                  let value = flags_preview[flag][0];
                                  let $ele  = flags_preview[flag][1];

                                  let f = parseInt(flag);

                                  switch (f) {
                                      case 1:
                                        $ele.find("#inllamada").val(value);
                                      break;
                                      case 2:
                                        $ele.find("#insubtitulo").val(value);
                                      break;
                                      case 3:                                      
                                        tinymce.activeEditor.setContent(value);
                                      break;
                                      case 4:                                      
                                        $ele.find('#inGrabar').prop('checked', value.rec);
                                        $ele.find('#inLlamar').prop('checked', value.call);
                                        $ele.find('#inWhatsapp').prop('checked', value.wa);
                                        $ele.find('#inEmail').prop('checked', value.email);
                                        break;
                                      case 5:                               
                                        $ele.find('#inMercado').prop('checked', value.rec);
                                        $ele.find('#inRapi').prop('checked', value.call);
                                        $ele.find('#inFacil').prop('checked', value.wa);
                                        $ele.find('#inOtros').prop('checked', value.email);
                                        break; 
                                      case 6: 
                                          $ele.find("#inimagen-preview").attr("src",value);
                                          break;                                      
                                      case 7:
                                        $ele.find("#incolor-preview").val(value);
                                        $ele.find(".card").val(value);
                                        break;
                                  }
                              }

                              GetHTML();

                            }
                        } 

                      } else if (window.type=="message") { 

                        let modules_message = docWeb.data().inputs_message;
                        if (modules_message != undefined) {                            

                            var mlength = Object.keys(modules_message).length;
                            
                            if (mlength > 0 ) {

                              var flags_message = [];                                     

                              for ($m in modules_message) {

                                let module_message = modules_message[$m];

                                var $orig, name, flag;

                                switch (module_message.key) {
                                  case "texto":
                                    $orig = $("#ori-txto");                                                                
                                    flag = 1;
                                    break;                                  
                                }

                                name = module_message.key;

                                var $ele = $orig.clone()
                                  .addClass("dropped")
                                  .css({"position": "static", "left": null, "right": null})                            
                                  .appendTo( "#drop-area" );

                                await drop_element($ele, name, $orig);                        
                                
                                flags_message[flag] = [module_message.value, $ele]; 

                              } 
                          
                              for (flag in flags_message) { 
                                
                                  let value = flags_message[flag][0];
                                  let $ele  = flags_message[flag][1];

                                  let f = parseInt(flag);

                                  switch (f) {
                                      case 1:                                        
                                        tinymce.activeEditor.setContent(value);
                                      break;                                      
                                  }
                              }

                              GetHTML();

                            }
                        }                      

                      } else if (window.type=="web") { 
                      
                        let modules_web = docWeb.data().inputs_web; 
                        if (modules_web!=undefined) {

                            let html = docWeb.data().html_preview;
                            let public_image_web = docWeb.data().public_image_web;
                            let img = `<img src="${public_image_web}"/>`;

                            let background_color_web = docWeb.data().background_color_web;
                            
                            $("#web-image").remove();
                            $("#web").append(img);

                            var mlength = Object.keys(modules_web).length;
                        
                            if ( mlength > 0 ) {

                                var flags_web = [];                                     

                                for ($m in modules_web) {

                                  let module_web = modules_web[$m];
                                  
                                  var $orig, name, flag;

                                  switch (module_web.key) {
                                    case "saludo":
                                      $orig = $("#ori-saludo");                                                                
                                      flag = 1;
                                      break;
                                    case "cuerpo":
                                      $orig = $("#ori-cuerpo");                                                                
                                      flag = 2;                                
                                      break;
                                    case "contacto":
                                      $orig = $("#ori-contacto");                                                                
                                      flag = 3;                                
                                      break;
                                    case "pagos":
                                      $orig = $("#ori-pagos");                                                                
                                      flag = 4;                                
                                      break;
                                    case "facturas":
                                      $orig = $("#ori-facturas");                                                                
                                      flag = 5;                                
                                      break;
                                    case "imagen-web":
                                      $orig = $("#ori-imagen-web");                                                                
                                      flag = 6;                                
                                      break;
                                    case "color-web":
                                      $orig = $("#ori-color-web");                                                                
                                      flag = 7;                                
                                      break;
                                  }

                                  name = module_web.key;

                                  var $ele = $orig.clone()
                                    .addClass("dropped")
                                    .css({"position": "static", "left": null, "right": null})                            
                                    .appendTo( "#drop-area" );                                    

                                    await drop_element($ele, name, $orig, flag);                        
                                  
                                    flags_web[flag]= [module_web.value, $ele]; 

                                }                                 

                                for (flag in flags_web) { 
                                  
                                    let value = flags_web[flag][0];
                                    let $ele  = flags_web[flag][1];

                                    let f = parseInt(flag);

                                    switch (f) {
                                        case 1:
                                          $ele.find("#insaludo").val(value);
                                        break;
                                        case 2:                                      
                                          tinymce.activeEditor.setContent(value);
                                        break;
                                        case 3:                                      
                                          $ele.find('#inGrabar').prop('checked', value.rec);
                                          $ele.find('#inLlamar').prop('checked', value.call);
                                          $ele.find('#inWhatsapp').prop('checked', value.wa);
                                          $ele.find('#inEmail').prop('checked', value.email);
                                          break;
                                        case 4:                               
                                          $ele.find('#inMercado').prop('checked', value.mer);
                                          $ele.find('#inRapi').prop('checked', value.call);
                                          $ele.find('#inFacil').prop('checked', value.wa);
                                          $ele.find('#inOtros').prop('checked', value.email);
                                          break;
                                        case 5:                                                                           
                                          $ele.find('#inDescargar').prop('checked', value.des);
                                          $ele.find('#inDetalle').prop('checked', value.det);                                            
                                          $ele.find('#inMonto').prop('checked', value.mon);   
                                          if (value.tit) {
                                            $ele.find("#infacturas").val(value.tit);                                         
                                          }                                        
                                          break;                                          
                                        case 6: 
                                          $ele.find("#inimagen-web").attr("src",value);
                                          break;
                                        case 7:
                                          $ele.find("#incolor-web").val(value);
                                          break;
                                    }
                                }

                                GetHTML();                                  
                            }

                          }                                               
                      }
                 }
                  
              });  
          }   
        
          
          //$("#save-web").on('click', async function() {                                  
          
          //SaveComposed = async function() {

          $("#save-design").on('click', async function() { 

              console.log("**************");
              console.log("*** SAVING ***");
              console.log("**************");

              $("#spinner-save").removeClass("d-none");    

              let inputsHtml = await GetHTML();  

              let _html_ = inputsHtml[0];
              var modules = inputsHtml[1];

              var _time =  new Date();  

              var _html = _html_.replace(/\n|\t/g, ' ');   //break    
              _html = _html.replace(/\>[\t ]+\</g, "><");  // whitespace between tags       

              var background_color; 
              var payload;

              var docPath = window.documentPath + "/designs/" + window.designId;              
              const encodedPath = window.btoa(docPath);
              var htmlRef = firestore.doc(docPath); 

              if (window.type=="preview") {

                for ($m in modules) {
                  let module = modules[parseInt($m)];                              
                  if (module.key == "color-preview") {
                    background_color = module.value;
                  }
                }     

                var image_width         = 300; //$("#preview-preview").width();
                var image_height        = $("#preview-preview").height() + 60;          

                payload = {        
                  html_preview: _html,
                  inputs_preview: modules,                
                  encoded_path: encodedPath,
                  image_width_preview: parseInt(image_width),
                  image_height_preview: parseInt(image_height),
                  last_update: _time,                
                  preview_update: true                
                };

                if (background_color) {
                  let _color = background_color.gradient_color;
                  payload.background_color_preview = _color;
                } 

              } else if (window.type=="message") {

                payload = {        
                  html_web: _html,
                  inputs_web: modules,                
                  encoded_path: encodedPath,
                  image_width_web: parseInt(image_width),
                  image_height_web: parseInt(image_height),
                  last_update: _time,                
                  web_update: true                
                };


              } else if (window.type=="web") {
                
                for ($m in modules) {
                  let module = modules[parseInt($m)];                              
                  if (module.key == "color-web") {
                    background_color = module.value;
                  }
                }               
                
                var image_width         = $("#preview-web").width();
                var image_height        = $("#preview-web").height() + 60;          

                payload = {        
                  html_web: _html,
                  inputs_web: modules,                
                  encoded_path: encodedPath,
                  image_width_web: parseInt(image_width),
                  image_height_web: parseInt(image_height),
                  last_update: _time,                
                  web_update: true                
                };

                if (background_color) {
                  let _color = background_color.gradient_color;
                  payload.background_color_web = _color;
                }  

              }       

              firestore.doc(docPath).set(payload,{ merge: true }).then(docRefSet => {

                 //let path = docRefSet.path;

                 $("#spinner-save").hide();    

                  /*htmlRef.get()
                      .then(function(doc) {

                        let last = formatDate(doc.data().last_update);
                        $("#save").text("Saved: " + last);

                  });*/ 
                
              }).catch((error) => {     
                console.error("Error adding document: ", error);           
              }); 
              
              function reverseArr(input) {
                  var ret = new Array;
                  for (var i = input.length-1; i >= 0; i--) {
                      ret.push(input[i]);
                  }
                  return ret;
              }

              function formatDate(date) {
                var d = new Date(date),
                    month = '' + (d.getMonth() + 1),
                    day = '' + d.getDate(),
                    year = d.getFullYear();
            
                if (month.length < 2) 
                    month = '0' + month;
                if (day.length < 2) 
                    day = '0' + day;
            
                return [day, month, year].join('-');
            }

          });
       
          $( ".draggable" ).draggable({
            appendTo: "body",
            helper: "clone"
          });       
         

          $( ".droppable" ).droppable({
            accept: ".draggable",
            helper: "clone",
            hoverClass: "droppable-active",
            drop: async function( event, ui ) {
              
              $(".empty-form").remove();
              var $orig = $(ui.draggable);
              
              if(!$(ui.draggable).hasClass("dropped")) {               

                var name = $orig.find("label").attr("for");         
                var $el = $orig.clone();                
                
                //Remove drag options when element is color
                if (name=="ori-for-color-preview") {
                  $el.draggable({                    
                    start: function( event, ui ) {                  
                      $(ui.draggable).remove();                      
                    }
                  });
                }
                
                $el.addClass("dropped")
                  .css({"position": "static", "left": null, "right": null})
                  .appendTo(this);

                  let sname = name.split("ori-for-")[1];
                 
                  await drop_element($el, sname, $orig);                
               
              } else {
               
                if($(this)[0]!=$orig.parent()[0]) {
                
                  var $el = $orig
                    .clone()
                    .css({"position": "static", "left": null, "right": null})
                    .appendTo(this);
                  $orig.remove();

                }

              }
            }
          }).sortable();

          var drop_element = async function ($ele, name, $orig) {

            const dropPromise = new Promise(async (resolve, reject) => {

                count_drop++;

                if (window.type=="preview") {                 

                  switch(name) {

                    case "llamada":                      
                      $ele.filter("#ori-llamada").attr("id","llamada");
                      $('label[for|="ori-for-llamada"]').attr('for', "for-llamada");
                      $("#llamada").find("#ori-inllamada").attr("id","inllamada");                  
                      $ele.find("p").remove();
                      break;

                    case "subtitulo":                      
                      $ele.filter("#ori-subtitulo").attr("id","subtitulo");
                      $('label[for|="ori-for-subtitulo"]').attr('for', "for-subtitulo");
                      $("#subtitulo").find("#ori-insubtitulo").attr("id","insubtitulo");                  
                      $ele.find("p").remove();
                      break;

                    case "mensaje":                    
                      $ele.filter("#ori-mensaje").attr("id","mensaje");
                      $('label[for|="ori-for-mensaje"]').attr('for', "for-mensaje");
                      let inmensaje = "inmensaje";
                      $("#mensaje").find("#ori-inmensaje").attr("id",inmensaje); 
                      $ele.filter("p").remove();                   
                      $("#mensaje").find("input").replaceWith(`<textarea id="${inmensaje}"></textarea>`);                              
                      $("#mensaje").find("textarea").removeAttr('placeholder');
                      await InitTinyEMC(inmensaje);
                      break;

                    case "fondo":
                      $ele.filter("#ori-fondo").attr("id","fondo");  
                      $('label[for|="ori-for-fondo"]').attr('for', "for-fondo");                      
                      $("#fondo").find("#ori-infondo").attr("id","infondo");                            
                      $ele.filter("p").remove(); 
                      $("#fondo").find("input").attr('id', 'inimage');                   
                      $("#fondo").find("input").change(function() {                      
                          if (this.files && this.files[0]) {
                            saveImage(files);
                          }
                      });
                      break;

                      case "imagen-preview":
                        $ele.filter("#ori-imagen-preview").attr("id","imagen-preview");
                        $ele.filter("#ori-for-imagen-preview").attr("id","for-imagen-preview");
                        $ele.filter("p").remove(); 
                        $ele.filter("input").attr('id', 'inimage-preview');                   
                        $ele.filter("input").change(function() {                      
                            if (this.files && this.files[0]) {
                              saveImage(files);
                              //$('.YourContainer').css('background-image','url(http://images.visitcanberra.com.au/images/canberra_hero_image.jpg)');
                            }
                        });
                        break;  

                      case "pie":
                        $ele.filter("#ori-pie").attr("id","pie");
                        $('label[for|="ori-for-pie"]').attr('for', "for-pie");                                             
                        $("#pie").find("#ori-pie").attr("id","inpie");                        
                        $("#pie").find("#ori-inInfo").attr("id","inInfo");
                        $("#pie").find("#ori-inDescuento").attr("id","inDescuento");
                        $("#pie").find("#ori-inReclamar").attr("id","inReclamar");
                        $("#pie").find("#ori-inContactar").attr("id","inContactar");
                        $ele.find("p").remove();      
                        $('#pie input[type="checkbox"]').click(function(){
                          GetHTML();
                        });
                        break;

                    case "color-preview":            

                      $ele.find("#color-preview").removeClass("draggable");
                      $ele.filter("#ori-color-preview").attr("id","color-preview");
                      $('label[for|="ori-for-color-preview"]').attr('for', "for-colr-preview");   
                      $ele.find("#ori-grapick").attr('id', 'grapick'); 
                     
                      $ele.find("#ori-grapick-inputs").attr('id', 'grapick-inputs');
                      $ele.find("#grapick-inputs").removeClass("d-none");      

                      $ele.find("#ori-switch-type").attr('id', 'switch-type');
                      $ele.find("#ori-switch-angle").attr('id', 'switch-angle');                    

                      createGrapick();
                     
                      break;

                    }     
                    
                    let removeLinkId = 'remove-link-' + $ele.attr('id');
                    let removeId = name;                     

                    //<i class="fa icon-move icon-2"></i>
                    
                    $(`
                      <p class="tools">
                        <div class="row">
                          <div id="move-color-preview" class="draggable">
                            <a id="${removeLinkId}" onclick="window.RemoveElement('${removeId}');" class="text-primary remove-link">
                              <i class="pl-3 fa fa-trash fa-2x" aria-hidden="true"></i>
                            </a>
                            <i class="pl-3 fa fa-arrows-v fa-2x" aria-hidden="true"></i>                                                         
                          </div>
                        </div>
                      </p>
                    `).appendTo($ele);                             

                    var timer = setTimeout(function() {                                        

                      $("#inllamada").focus(function() {
                        $(this).css("background-color", "#EFF0F1");                                       
                        active.mensaje      = false;                                             
                        active.subtitulo    = false;                                             
                        active.from_button  = false;
                        active.llamada      = true;
                      });

                      $("#inllamada").blur(function() {
                        $(this).css("background-color", "white");
                        if (active.from_button) {
                          active.llamada = false;
                        }
                      });

                      $("#inllamada").change(function() {
                        GetHTML();
                      });

                      $("#insubtitulo").focus(function() {
                        $(this).css("background-color", "#EFF0F1");                                       
                        active.mensaje      = false;                                             
                        active.from_button  = false;
                        active.llamada      = false;
                        active.subtitulo    = true; 
                      });

                      $("#insubtitulo").blur(function() {
                        $(this).css("background-color", "white");
                        if (active.from_button) {
                          active.subtitulo = false;
                        }
                      });

                      $("#insubtitulo").change(function() {
                        GetHTML();
                      });

                      clearTimeout(timer);

                      resolve();

                    }, 500);


                } else if (window.type=="message") {
                 
                    switch (name) {

                      case "text":                      
                        $ele.filter("#ori-texto").attr("id","texto");
                        $('label[for|="ori-for-texto"]').attr('for', "for-texto");
                        let intexto = "intexto";
                        $("#texto").find("#ori-intexto").attr("id",intexto); 
                        $ele.filter("p").remove();                   
                        $("#texto").find("input").replaceWith(`<textarea id="${intexto}"></textarea>`);                              
                        $("#texto").find("textarea").removeAttr('placeholder');         
                        await InitTinyEMC(intexto);
                        break;

                    }

                } else if (window.type=="web") {
                 
                  switch (name) {

                    case "saludo":                      

                      $ele.filter("#ori-saludo").attr("id","saludo");
                      $('label[for|="ori-for-saludo"]').attr('for', "for-saludo");
                      $("#saludo").find("#ori-insaludo").attr("id","insaludo");       
                      $ele.find("p").remove();
                      break;

                    case "cuerpo":

                      $ele.filter("#ori-cuerpo").attr("id","cuerpo");
                      $('label[for|="ori-for-cuerpo"]').attr('for', "for-cuerpo");                      
                      let incuerpo = "incuerpo";
                      $("#cuerpo").find("#ori-incuerpo").attr("id",incuerpo); 
                      $ele.filter("p").remove();                   
                      $("#cuerpo").find("input").replaceWith(`<textarea id="${incuerpo}"></textarea>`);                              
                      $("#cuerpo").find("textarea").removeAttr('placeholder');         
                      await InitTinyEMC(incuerpo);
                      break;

                    case "contacto":                     

                      $ele.filter("#ori-contacto").attr("id","contacto");
                      $('label[for|="ori-for-contacto"]').attr('for', "for-contacto");              
                      $("#contacto").find("#ori-inGrabar").attr("id","inGrabar");
                      $("#contacto").find("#ori-inLlamar").attr("id","inLlamar");
                      $("#contacto").find("#ori-inWhatsapp").attr("id","inWhatsapp");
                      $("#contacto").find("#ori-inEmail").attr("id","inEmail");

                      $ele.find("p").remove();   
                      $('#contacto input[type="checkbox"]').click(function(){
                        GetHTML();
                      });         
                      break;

                    case "pagos":    

                      $ele.filter("#ori-pagos").attr("id","pagos");
                      $('label[for|="ori-for-pagos"]').attr('for', "for-pagos");             
                      $("#pagos").find("#ori-inpagos").attr("id","inpagos");
                      $("#pagos").find("#ori-inMercado").attr("id","inMercado");
                      $("#pagos").find("#ori-inFacil").attr("id","inFacil");
                      $("#pagos").find("#ori-inOtros").attr("id","inOtros");

                      $ele.find("p").remove();      
                      $('#pagos input[type="checkbox"]').click(function(){
                        GetHTML();
                      });
                      break;

                    case "facturas":
                      
                      $ele.filter("#ori-facturas").attr("id","facturas");
                      $('label[for|="ori-for-facturas"]').attr('for', "for-facturas");                      
                      $("#facturas").find("#ori-infacturas").attr("id","infacturas");
                      $("#facturas").find("#ori-inMonto").attr("id","inMonto");
                      $("#facturas").find("#ori-inDetalle").attr("id","inDetalle");
                      $("#facturas").find("#ori-inDescargar").attr("id","inDescargar");

                      $ele.find("p").remove();      
                      $('#facturas input[type="checkbox"]').click(function(){
                        GetHTML();
                      });
                      break;

                    case "imagen-web":
                      
                      $ele.filter("#ori-imagen-web").attr("id","imagen-web");
                      $('label[for|="ori-for-imagen-web"]').attr('for', "for-imagen-web");                      
                      $ele.filter("p").remove(); 
                      $("#imagen-web").find("input").attr('id', 'inimage-web');                   
                      $("#imagen-web").find("input").change(function() {                      
                          if (this.files && this.files[0]) {
                            saveImage(files);
                          }
                      });
                      break;

                    case "color-web":
                      
                      $ele.filter("#ori-color-web").attr("id","color-web");
                      $('label[for|="ori-for-color-web"]').attr('for', "for-color-web");                                      
                      
                      $ele.filter("p").remove();
                      $("#color-web").find("input").attr('id', 'incolor-web');                 
                      $('#incolor-web').colorpicker();                        
                      $('#incolor-web').on('colorpickerChange', function(event) {
                        let c = event.color.toString();
                        $( "#color-web" ).data( "data-color", c );
                        $('#preview-web').css('background-color', c);
                      });
                      break;
                      
                  }                
                  
                  $('<p class="tools">\
                    <a class="text-primary edit-link">Visualizar<a> | \
                    <a class="text-primary remove-link">Remover</a></p>').appendTo($ele);                             

                  var timer = await setTimeout(function() {   

                    $("#insaludo").focus(function() {
                      $(this).css("background-color", "#EFF0F1");                      
                      active.facturas     = false;                     
                      active.cuerpo       = false;
                      active.from_button  = false;
                      active.saludo       = true; 
                    });

                    $("#insaludo").blur(function() {
                      $(this).css("background-color", "white");
                      if (active.from_button) {
                        active.saludo     = false;
                      }
                    });

                    $("#insaludo").change(function() {
                      GetHTML();
                    });

                    $("#infacturas").focus(function() {
                      $(this).css("background-color", "#EFF0F1");
                      active.saludo       = false;                      
                      active.cuerpo       = false;
                      active.from_button  = false;
                      active.facturas     = true;                      
                    });

                    $("#infacturas").blur(function() {
                      $(this).css("background-color", "white");
                      if (active.from_button) {
                        active.facturas = false;
                      }
                    });

                    $("#infacturas").change(function() {
                      GetHTML();
                    });

                    clearTimeout(timer);

                    resolve();

                  }, 500);

                } 

              });
              
              return dropPromise;

          }          

          function saveImage(files) {
            var reader = new FileReader();            
            reader.onload = function (e) {                              
                
              //target_result = e.target.result;

                let docPath = window.documentPath + "/designs/" + window.designId; 
                let paths = url_path.split("/");
                let _image_ 			= image_name + "_web.png";
                var image_storage  		= url_path.split(paths[4])[0];

                var storageRef = storage.ref("/posts");                                        
                var filePath =  title + ".png";
                const imageRef = storageRef.child(imgName)
                imageRef.put(img)
                .then(snapshot => {
                    return imageRef.getDownloadURL()
                    .then(url => {
                        // url is the download URL
                    })
                })
                .catch(error => {
                    // deal any errors
                });
                GetHTML();
            }            
            reader.readAsDataURL(this.files[0]);
          }

          var GetHTML = async function () {           

            $("#preview").empty();      
            
            const htmlPromise = new Promise(async (resolve, reject) => {  

              var count = 0;
              var _html_preview = "";              
              var _html_message = "";
              var imageHeight = "";
              var _html_web = "";
              var modules = {};

               $('#drop-area').children('div').each(function(index, value) { 
                  
                  try {

                    console.log(`div${index}: ${this.id}`);

                    var value;                                                          
                    var json = {};

                    if (_html_preview == "") {                                
                        imageHeight = " height:400px;"
                        _html_preview = `<div class="card" style><div class="card-block">`;
                    } 

                    if (window.type=="preview") {

                      switch (this.id) {
                        case "llamada":
                          count++;
                          let inllamada  = value = $(this).find("#inllamada").val();
                          let llamada   =  `<h4 class="card-title">${inllamada}</h4>`;
                          _html_preview += llamada;                                                                
                          break;
                        case "subtitulo":
                          count++;
                          let insubtitulo  = value = $(this).find("#insubtitulo").val();
                          let subtitulo   =  `<h6 class="card-subtitle text-muted">${insubtitulo}</h6>`;                                                
                          _html_preview += subtitulo;                                                                
                          break;
                        case "mensaje":
                          count++;
                          let inmensaje = value = tinymce.activeEditor.getContent();
                          let mensaje   =  `<p class="card-text p-y-1">${inmensaje}</p>`;                                          
                          _html_preview += mensaje;
                          break;                            
                        case "pie":
                          count++;   
                          let inInfo        = $('#inInfo').prop('checked');             
                          let inDescuento     = $('#inDescuento').prop('checked');
                          let inReclamar   = $('#inReclamar').prop('checked');
                          let inContactar = $('#inContactar').prop('checked');                                
                          value = JSON.parse(`{"inf":${inInfo}, "con":${inDescuento}, "fin":${inReclamar}, "des":${inContactar}}`);                                                       
                          let pie = getPie(value);
                          if (pie!=undefined) {
                            _html_preview += pie;
                          }
                          break;
                        case "fondo":
                          count++;                
                          let inMercado   = $('#inMercado').prop('checked');
                          let inRapi      = $('#inRapi').prop('checked');
                          let inFacil     = $('#inFacil').prop('checked');
                          let inOtros     = $('#inOtros').prop('checked');                           
                          value = JSON.parse(`{"mercado":${inMercado}, "rapi":${inRapi}, "facil":${inFacil}, "otros":${inOtros}}`);
                          let pagos = getPagos();
                          if (pagos!=undefined) {
                            _html_preview += pagos;
                          }                         
                          break;
                        case "color-preview":
                          count++;                            
                          if (gradient_color!=undefined) {                                                      
                            let style = `style="background-image:${gradient_color};${imageHeight}"`;                              
                            _html_preview = _html_preview.replaceAll("style", style);             
                          }    
                          let _json_color = `{"gradient_color":"${gradient_color}"}`;
                          value = JSON.parse(_json_color);
                          break;
                      }        

                      json["value"] = value;                                          
                      json["key"] = this.id;                                          
                      modules[count] = json;                     

                      if (count_drop == count) {                                     

                        //_html_preview += `<a href="#" class="card-link">Desuscribir -></a>`;
                        _html_preview += `</div></div>`;                            
                        _html_preview = replaceVariables(_html_preview);

                        $("#preview-preview").html(_html_preview);                                                               

                        resolve([_html_preview, modules]);

                      }  

                    } else if (window.type=="message") {

                      switch (this.id) {

                        case "texto":
                          count++;
                          let intexto = value = tinymce.activeEditor.getContent();
                          let text  =  `<p class="card-text p-y-1">${intexto}</p>`;                                          
                          _html_message += text;
                          break; 
                      }

                      $("#preview-message").html(_html_message);                                                               

                      resolve([_html_message, modules]);                   

                    } else if (window.type=="web") {
                    
                        switch (this.id) {
                          case "saludo":
                            count++;
                            let insaludo = value = $(this).find("#insaludo").val();
                            let saludo =  `<h3 style="margin-bottom: 50px;"><p class="font-weight-bold">
                                          ${insaludo}</p></h3>`;
                            _html_web += saludo;                                                                
                            break;
                          case "cuerpo":
                            count++;
                            let inscuerpo = value = tinymce.activeEditor.getContent();
                            let cuerpo =  `<div style="margin-bottom: 40px;">
                                        ${inscuerpo}</div>`;
                            _html_web += cuerpo;
                            break;
                          case "pagos":
                            count++;                
                            let inMercado = $('#inMercado').prop('checked');
                            let inRapi = $('#inRapi').prop('checked');
                            let inFacil = $('#inFacil').prop('checked');
                            let inOtros = $('#inOtros').prop('checked');                           
                            value = JSON.parse(`{"mercado":${inMercado}, "rapi":${inRapi}, "facil":${inFacil}, "otros":${inOtros}}`);
                            let pagos = getPagos();
                            if (pagos!=undefined) {
                                _html_web += pagos;
                            }                         
                            break;
                          case "contacto":
                            count++;                
                            let inGrabar    = $('#inGrabar').prop('checked');
                            let inLlamar    = $('#inLlamar').prop('checked');
                            let inWhatsapp  = $('#inWhatsapp').prop('checked');
                            let inEmail     = $('#inEmail').prop('checked');                        
                            value = JSON.parse(`{"rec":${inGrabar}, "call":${inLlamar}, "wa":${inWhatsapp}, "email":${inEmail}}`);
                            let contacto = getContacto();
                            if (contacto!=undefined) {
                              _html_web += contacto;
                            }                         
                            break;
                          case "facturas":
                            count++;                                            
                            let inDescargar = $('#inDescargar').prop('checked');
                            let inDetalle    = $('#inDetalle').prop('checked');                                                 
                            let inMonto    = $('#inMonto').prop('checked');                                                 
                            let infactura = $(this).find("#infacturas").val();
                            var fact = "";
                            if (infactura!="") {
                              fact = `"tit":"${infactura}",`;
                            }                                                      
                            value = JSON.parse(`{${fact}"des":${inDescargar}, "det":${inDetalle}, "mon":${inMonto}}`);                            
                            let facturas = getFacturas(value, infactura);
                            if (facturas!=undefined) {
                              _html_web += facturas;
                            }                         
                            break;
                          case "imagen":
                            count++;                       
                            if ( $("#inimagen").val() != undefined ) {
                              let inimagen =  `<div style="width:100%; height:100%">
                                              <img style="margin-left: auto;  margin-right: auto; display: block; width: 50%;"
                                              src="${target_result}"></div>`;
                              _html_web += inimagen;
                            }
                            break;
                          case "color-web":
                            count++;  
                            let color = value = $(this).find("#incolor-web").val();                                 
                            if (color!=undefined) {
                                let style = `style="background-color:${color}"`;                              
                                _html_web = _html_web.replaceAll("style", style);             
                              } 
                            break;
                        }        

                        json["value"] = value;                                          
                        json["key"] = this.id;                                          
                        modules[count] = json;                     

                        if (count_drop == count) {                                     

                          let comupulsory = `
                          <footer class="footer">
                            <div class="container">
                              <hr>              
                              <div class="row">
                                <div class="col-sm-2"/>                        
                                <div class="col-sm-8">
                                  <button type="button" class="btn btn-secondary col-12">No soy esa persona</button>
                                </div>
                                <div class="col-sm-2"/>
                              </div>
                              <div class="row pt-4">
                                <div class="col-sm-2"/>                        
                                <div class="col-sm-8">
                                  <button type="button" class="btn btn-primary col-12">Desuscribir</button>
                                </div>
                                <div class="col-sm-2"/>
                              </div>
                              <br>
                            </div>
                          </footer>`;

                          _html_web += comupulsory;
                          _html_web = replaceVariables(_html_web);
                          $("#preview-web").html(_html_web);                                                               

                          resolve([_html_web, modules]);

                        }  
                      
                  }
                  ///https://codepen.io/modelsofidentity/pen/gRaXPg/

             
                } catch (e) {
                    console.error(e);
                    reject(e);
                }

              });

            });

            /*if (timer_save==null) {

              new Promise(function(resolve, reject) {

                timer_save = setTimeout(function() { 
                  
                    SaveComposed();
                    clearTimeout(timer_save);
                    timer_save=null;
                    resolve();

                }, 2000);

              });

            }*/

            return htmlPromise;

          };        

          function getPie(value) {

            let _html = "";            

            if (value.inf){
              let info = $('#inInfo').closest('label').text();
              _html += `<a href="#" class="card-link">${info}</a>`;
            }                              
            
            if (value.con){
              let cono = $('#inDescuento').closest('label').text();
              _html += `<a href="#" class="card-link">${cono}</a>`;
            }
            
            if (value.fin){
              let fina = $('#inReclamar').closest('label').text();
              _html += `<a href="#" class="card-link">${fina}</a>`;
            }
            
            if (value.des){
              let desc = $('#inContactar').closest('label').text();
              _html += `<a href="#" class="card-link">${desc}</a>`;
            }

            return _html;

          };

          function getPagos() {

              var arrayObj = [
                {"image": "mercadopago.png", "id": "inMercado", "value": $('#inMercado').prop('checked')},
                {"image": "rapipago.png", "id": "inRapi", "value": $('#inRapi').prop('checked')},
                {"image": "pagofacil.png", "id": "inFacil", "value": $('#inFacil').prop('checked')},
                {"image": "otros.png", "id": "inOtros", "value": $('#inOtros').prop('checked')},
              ];

              var _array = arrayObj.filter(function(s) { 
                return s.value; 
              });

              count = _array.length;

              if (count==0) {
                return;
              }
              var inpagos = "";

              switch (count) {
                case 1:
                  inpagos = `<div class="row">
                      <div class="col">                         
                      </div>
                      <div class="col-5">
                        <img src="/images/${_array[0].image}"/>
                      </div>
                      <div class="col">                          
                      </div>
                    </div>`;
                  break;
                case 2:
                  inpagos = "";
                  break;
                case 3:
                  inpagos = "";
                  break;
              }
              return inpagos;
          }


          function getContacto() {

            var arrayObj = [
              {"image": "record.png", "id": "inGrabar", "value": $('#inGrabar').prop('checked')},
              {"image": "call.png", "id": "inLlamar", "value": $('#inLlamar').prop('checked')},
              {"image": "whatsapp.png", "id": "inWhatsapp", "value": $('#inWhatsapp').prop('checked')},
              {"image": "gmail.png", "id": "inEmail", "value": $('#inEmail').prop('checked')},
            ];

            var _array = arrayObj.filter(function(s) { 
              return s.value; 
            });

            count = _array.length;

            if (count==0) {
              return;
            }

            var incontactos = "";

            switch (count) {
              case 1:
              incontactos = `<div class="row">
                    <div class="col">                         
                    </div>
                    <div class="col-5">
                      <img src="/images/${_array[0].image}"/>
                    </div>
                    <div class="col">                          
                    </div>
                  </div>`;
                break;
              case 2:
                incontactos = "";
                break;
              case 3:
                incontactos = "";
                break;
            }
            return incontactos;
          }

          function getFacturas(value, infactura) {     
            
            var _html = "";

            if (infactura) {
              _html +=  `<h4 class="pt-3" style="margin-bottom: 30px;"><p class="font-weight-bold">
                                            ${infactura}</p></h4>`;
            }         

            if ( value.des==true || value.det==true || value.mon==true) {

                var today = new Date();
                var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
                var number = "10354";
                var amount  = "$87.000";

                var table = 
                `<table id="field-table" class="pt-1 table table-bordered table-hover table-sm">
                  <thead>
                    <tr>                      
                      <th>
                        Fecha 
                      </th>
                      <th>
                        Numero
                      </th>`;
                      if (value.mon) {                  
                        table += `<th>
                                    Monto 
                                  </th>`; 
                      }                                  
                      if (value.det || value.des) {                  
                        table += `<th>
                                    Acciones 
                                  </th>`;
                      }                                                                                      
                      table +=`</tr>
                  </thead>
                  <tbody>
                    <tr id="field0">
                      <td>
                        ${date}
                      </td>
                      <td>
                        ${number}
                      </td>`;
                      if (value.mon) {                  
                        table += `<td>            
                          ${amount}
                        </td>`;
                      }
                      if (value.det || value.des) {                  
                        table += `<td><div class="row pt-2">`;
                        if (value.det) {
                          table += `<i class="pl-4 fa fa-eye" aria-hidden="true"></i>`;
                        }              
                        if (value.des) {                  
                          table += `<i class="pl-4 fa fa-download" aria-hidden="true"></i>`;
                        }
                        table += `<div></td>`;
                      }                        
                   table += `</tr>                              
                  </tbody>
                </table>`;

                _html += table;

              } 
            
              return _html
          }
        

          function replaceVariables(_html) {
            for (var key of Object.keys(data)) {                
              let nombre = "{" + key + "}";
              let datos = data[key]["datos"];
              _html = _html.replaceAll(nombre, datos);             
            }
            return _html;
          }

          var get_modal = function(content) {
          var modal = $('<div class="modal" style="overflow: auto;" tabindex="-1">\
            <div class="modal-dialog">\
              <div class="modal-content">\
                <div class="modal-header">\
                  <a type="button" class="close"\
                    data-dismiss="modal" aria-hidden="true">&times;</a>\
                  <h4 class="modal-title">Edit HTML</h4>\
                </div>\
                <div class="modal-body ui-front">\
                  <textarea class="form-control" \
                    style="min-height: 200px; margin-bottom: 10px;\
                    font-family: Monaco, Fixed">'+content+'</textarea>\
                  <button class="btn btn-success">Update</button>\
                </div>\
              </div>\
            </div>\
            </div>').appendTo(document.body);            
          return modal;
        };
        
        $(document).on("click", ".edit-link", function(ev) {   
          
          GetHTML();
          
          /*var $el = $(this).parent().parent();
          var $el_copy = $el.clone();
          
          var $edit_btn = $el_copy.find(".edit-link").parent().remove();

          var $modal = get_modal(html_beautify($el_copy.html())).modal("show");
          $modal.find(":input:first").focus();
          $modal.find(".btn-success").click(function(ev2) {
            var html = $modal.find("textarea").val();
            if(!html) {
              $el.remove();
            } else {
              $el.html(html);
              $edit_btn.appendTo($el);
            }
            $modal.modal("hide");
            return false;
          });*/

        });                 

          

          var InitTinyEMC = async function (id) {  

            const tinyPromise = new Promise(async (resolve, reject) => {

                var camposFields = {
                  one: "first",
                  two: "second",
                  three: "third"
                };         
                
                /**
                 * SAMPLE
                 * https://www.tiny.cloud/docs/demo/basic/
                 * */

                if (tinymce.activeEditor) {                  
                  tinymce.activeEditor.destroy();
                }

                let _selector = 'textarea#' + id;

                tinymce.init({
                  selector: _selector,
                  menubar: false,
                  height: 200,             
                  plugins: [
                    'advlist autolink lists link image charmap print preview anchor',
                    'searchreplace visualblocks code fullscreen',
                    'insertdatetime media table paste code wordcount'
                  ],
                  toolbar: 'undo redo | formatselect | ' +
                  'bold italic backcolor | alignleft aligncenter ' +
                  'alignright alignjustify | bullist numlist outdent indent | ' +
                  'removeformat',
                  content_css: '//www.tiny.cloud/css/codepen.min.css',                  

                  setup: function(editor) {

                    editor.on('init', function(e) {
                        //console.log('init event', e);
                        resolve();
                    });

                    editor.on('change', function(ed) {              
                      let _content = editor.getContent();      
                      GetHTML();  
                    });
                    
                    /** Campos **/              
                    editor.ui.registry.addMenuButton('campos', {
                      text: 'Campos',
                      fetch: function(callback) {
                        var items = [];
                        for (var fieldName in camposFields) {
                          var menuItem = {
                            type: 'menuitem',
                            text: camposFields[fieldName],
                            value:fieldName,
                            onSetup: function(buttonApi) {
                              var $this = this;
                              this.onAction = function() {
                                editor.insertContent($this.data.value);
                              };
                            },
                          };
                          items.push(menuItem);
                        }
                        callback(items);
                      },
                    });
                  }
                });                

                tinymce.activeEditor.on('focus', function(e) {                  
                  if (window.type=="preview") {
                    active.mensaje      = true;
                    active.llamada      = false;
                    active.subtitulo    = false;
                  } else if (window.type=="web") {
                    active.cuerpo       = true;
                    active.saludo       = false;
                  }                  
                  active.from_button  = false;               
                });

                tinymce.activeEditor.on('blur', function(e) {                       
                  if (active.from_button) {
                    if (window.type=="preview") {
                      active.mensaje  = false;
                    } else if (window.type=="web") {
                      active.cuerpo   = false;
                    }                    
                  }                
                });
           
              });     
              
              return tinyPromise;

          };

        } else  {

        }

      });   

    });    

      /**
       * 
       * Custom Menu Item
       * //https://www.tiny.cloud/docs/demo/custom-menu-item/
       * 
       * Local Upload
       * https://www.tiny.cloud/docs-4x/demo/local-upload/
       * 
       * Image Upload
       * https://www.tiny.cloud/docs-4x/general-configuration-guide/upload-images/
       * 
       * */
      
    
    </script>

   
   
  </body>
</html>
