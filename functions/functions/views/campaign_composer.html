<!DOCTYPE html>
<html>
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

     <!-- Bootstrap CSS -->
     <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css">     
     <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
     <link rel="stylesheet" href="/vendor/colorPicker/css/bootstrap-colorpicker.css">
     <link rel='icon' href='https://vigil.com.ar/favicons/notimation.ico' type='image/x-icon' />
     
     <title>Noti Campaigns</title>    
    
      <style>  

      #rcard {
        border-radius: 25px;
        background: #73AD21;
        padding: 20px;
        width: 200px;
        height: 150px;
      }    

      .table-layout {
          text-align: center;
          border: 1px solid black;
          border-collapse: collapse;
          font-family:"Trebuchet MS";
          margin: 0 auto 0;
      }
      .table-layout td, .table-layout th {
          border: 1px solid grey;
          padding: 5px 5px 0;
      }
      .table-layout td {
          text-align: left;
      }
      .selected {
          color: red;
          background-color: yellow;
      }

      .form-control-xs {
          height: calc(1em + .375rem + 2px) !important;
          padding: .125rem .25rem !important;
          font-size: .75rem !important;
          line-height: 1.5;
          border-radius: .2rem;
      }
                
       
     </style>

  </head>

  <body>    

    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>    
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>        
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" defer></script>
    <script src="https://cdn.tiny.cloud/1/lr9wasio09vwo6la4k91gs8hybva1vp7oxw5k9cfpm2g5pm6/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.11.0/beautifier.js"></script>

    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>        
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>            
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-functions.js"></script>   

    <script src="https://kit.fontawesome.com/f014efefd7.js" crossorigin="anonymous"></script>

    <script src="/vendor/colorPicker/js/bootstrap-colorpicker.js"></script>

       
    
    <div class="container-fluid">


      <div class="row" style="padding-left: 50px;">
        <div class="col-md-12">          
          
          <!--<nav class="navbar navbar-expand-lg navbar-light bg-light navbar-dark bg-dark">
             
            button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
              <span class="navbar-toggler-icon"></span>
            </button> <a class="navbar-brand" href="#">Brand</a>
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="navbar-nav">
                <li class="nav-item active">
                   <a class="nav-link" href="#">Link <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                   <a class="nav-link" href="#">Link</a>
                </li>
                <li class="nav-item dropdown">
                   <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown">Dropdown link</a>
                  <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                     <a class="dropdown-item" href="#">Action</a> <a class="dropdown-item" href="#">Another action</a> <a class="dropdown-item" href="#">Something else here</a>
                    <div class="dropdown-divider">
                    </div> <a class="dropdown-item" href="#">Separated link</a>
                  </div>
                </li>
              </ul>
              <form class="form-inline">
                <input class="form-control mr-sm-2" type="text" /> 
                <button class="btn btn-primary my-2 my-sm-0" type="submit">
                  Search
                </button>
              </form>
              <ul class="navbar-nav ml-md-auto">
                <li class="nav-item active">
                   <a class="nav-link" href="#">Link <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item dropdown">
                   <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown">Dropdown link</a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdownMenuLink">
                     <a class="dropdown-item" href="#">Action</a> <a class="dropdown-item" href="#">Another action</a> <a class="dropdown-item" href="#">Something else here</a>
                    <div class="dropdown-divider">
                    </div> <a class="dropdown-item" href="#">Separated link</a>
                  </div>
                </li>
              </ul>
            </div>
          </nav>-->

          <br>

          <div class="row">
            <div id="login">
              Campoaign composer - Not Logged
            </div>  
            <div id="logout">
              Logout
            </div>
            <div class="col-md-4">
            </div>
            <div class="col-md-4">
              <h3 class="text-center">
                Noti Designer
              </h3>
            </div>
            <div class="col-md-4">
            </div>
          </div>

          <br>
          
          <div class="row">

            <div class="col-md-12">              

              <div class="row">                

                <!--NEW CAMPAIGN-->
                <div class="col-md-6">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="row">
                        <div class="col-md-6">
                           <span class="badge badge-default float-right"><h5>Nombre campaña:</h5></span>
                        </div>
                        <div class="col-md-6">
                          <input id="campaign-name" type="text" class="form-control">
                          <p>Crea el cuerpo del mensaje</p>                                    
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-md-6">
                          <div class="row float-right">
                            <span class="badge badge-default"><h5>Agregar campo</h5></span>
                            <button id="add-field" type="button" class="btn btn-success ">
                              +
                            </button>
                          </div>
                        </div>
                        <div class="col-md-6">                           
                          
                          <label class="btn btn-default">
                            Subir archivo de Excel <input id="excel-file" type="file" hidden>
                            <i class="fas fa-file-excel"></i>
                          </label>
                        </div>
                      </div>
                      <br>
                      <div class="row">
                        <div class="col-md-12">

                          <table id="field-table" class="table table-bordered table-hover table-sm">
                            <thead>
                              <tr>
                                <th>                                  
                                </th>
                                <th>
                                  Campo
                                </th>
                                <th>
                                  Valor
                                </th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr id="field0">
                                <td>
                                  <span class="glyphicon glyphicon-envelope"></span>                                
                                </td>
                                <td>
                                  <input id="name_0" type="text" class="form-control">
                                </td>
                                <td>
                                  <input id="value_0" type="text" class="form-control">
                                </td>                               
                              </tr>                              
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="row">
                        <div class="col-md-6">
                           
                          <button type="button" class="btn btn-success">
                            Borrar
                          </button>
                        </div>
                        <div class="col-md-6">
                           
                          <button id="save-campaign" type="button" class="btn btn-success">
                            Guardar Campaña
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                
                <!--TABLE-->
                <div class="col-md-6">
                  <table id="campaign-table"  class="table table-bordered table-hover table-sm">
                    <thead>
                      <tr>
                        <th>
                            <span class="custom-checkbox">
                                <input type="checkbox" id="selectAll">
                                <label for="selectAll"></label>
                            </span>
                        </th>
                        <th>Nombre</th>
                        <th>Actualizada</th>                 
                        <th></th>                        
                    </tr>
                    </thead>
                    <tbody>
                    
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <br>

          <div class="row">
            <div class="col-md-12">
              <h3 class="text-center">
                Noti Designer
              </h3>
              <div class="row float-left">
                <span class="badge badge-default"><h5>Nuevo diseño</h5></span>
                <button id="add-field" type="button" class="btn btn-success ">
                  +
                </button>
              </div>
              <br><br>
              
              <div class="row">                
                <div class="col-md-3">                  
                  <div id="cards" class="row">
                  </div>
              </div>

          <!-- Add Alert -->  
          <div id="alertModal" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">                                
                    <div class="modal-body">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <p id="alert-content"></p>
                    </div>                                
                    <div data-dismiss="modal" class="modal-footer"><button type="button" class="btn btn-primary">OK</button></div>
                </div>
            </div>
        </div>

        </div>
      </div>
    </div>

    <script>
    //<![CDATA[

    /**
     * PDF TO HTML
     * 
     * https://www.idrsolutions.com/online-pdf-to-html5-converter
     * 
     * */

    /**
     * Drag and drop
     * http://jsfiddle.net/vacidesign/uskx816g/
     * */

    /**
     * jquery Uncaught SyntaxError: "Unexpected token '<'"
     * https://idiallo.com/javascript/uncaught-syntaxerror-unexpected-token#n
     * 
     * */

    /**
     * Stepper into modal
     * 
     * https://bbbootstrap.com/snippets/modal-dialog-multi-step-form-wizard-29726524
     * */

    $(document).ready(function () {        

      var active_saludo = false;
      var active_cuerpo = false;
      var active_from_button = false;

      var target_result;

      var data;
      var count_drop = 0;

      var count_field = 1;

      const firebaseConfig = {
        apiKey: "AIzaSyAM4WQDHpHh1oRT_v-6ikquE4V809hA3kY",
        authDomain: "notims.firebaseapp.com",
        databaseURL: "https://notims.firebaseio.com",
        projectId: "notims",
        storageBucket: "notims.appspot.com",
        messagingSenderId: "79471870593",
        appId: "1:79471870593:web:ef29a72e1b1866b2bb4380",
        measurementId: "G-8T5N81L78J"
      };
      firebase.initializeApp(firebaseConfig);

      const db = firebase.firestore();
      const storage = firebase.storage();
      const database = firebase.database();
      const functions = firebase.functions();

      var getUrlParameter = function getUrlParameter(sParam) {
          var sPageURL = window.location.search.substring(1),
              sURLVariables = sPageURL.split('&'),
              sParameterName,
              i;

          for (i = 0; i < sURLVariables.length; i++) {
              sParameterName = sURLVariables[i].split('=');

              if (sParameterName[0] === sParam) {
                  return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
              }
          }
      };           
    
      $( "#login" ).click(function() {       

        firebase.auth()
        .signInWithEmailAndPassword("josemanuelvigil@gmail.com", "master")
        .then(function(user) {                      

          console.log(user.id);
          window.location.reload();            

        }).catch( function(error) {                         
            var errorMessage = error.message;  
            console.log(errorMessage);
        });

      });

       $( "#logout" ).click(function() {       

        firebase
          .auth()
          .signOut()
          .then(function () {            

            window.location.reload();  

          }).catch(function (error) {
            // An error happened.
            var errorMessage = error.message;  
            console.log(errorMessage);
          });

      });     
      
      firebase.auth().onAuthStateChanged(function (user) {

        if (user) { 

          $( "#login" ).text("Campoaign composer - Logged");

          window.account = getUrlParameter('account');
          //var campaignId = getUrlParameter('id');             
          
          db.collection('accounts')
          .doc(window.account)
          .collection("campaigns")
          .onSnapshot(snapshot => {
            
              let size = snapshot.size;            
              let changes = snapshot.docChanges();  

              if (size>0) {
              
                $("#campaign-table tbody tr").remove();
                $("#field-table tbody tr").remove();
                $("#campaign-name").val('');              

                changes.forEach(change => {
                    
                    let document = change.doc;
                    let id = document.id;  
                    window.campaignId = id;
                    let last = document.data().last_update.toDate();
                    let last_update = formatDate(last);  
                    
                    var campaign_name = id;                  
                    $("#campaign-name").val(campaign_name);
                    
                    let item = `<tr data-id="${document.id}">
                    <td>
                        <span class="custom-checkbox" class='clickable-row'>
                            <input type="checkbox" id="check_${document.id}" name="options[]" value="${document.id}">
                            <label for="${document.id}"></label>
                        </span>
                    </td>
                    <td>${campaign_name}</td>
                    <td>${last_update}</td>               
                    <td><a href="#" id="menu_${document.id}"><i class="fal fa-ellipsis-v"></i></a></td>        
                    </tr>`;
                    $('#campaign-table').append(item);

                    let fields = document.data().fields;

                    if ( fields.length>0 ) {                    

                      $("#field0").remove(); 

                      count_field = fields.length;
                      
                      for (var i=0; i < fields.length; i++) {              

                        let field = fields[i];                  
                        let name = field.name;
                        let value = field.value;

                        let item = `<tr id="field${i}">
                          <td>
                            <span class="glyphicon glyphicon-envelope"></span>                                </td>
                          <td>
                            <input id="name_${i}" value="${name}" type="text" class="form-control">
                          </td>
                          <td>
                            <input id="value_${i}" value="${value}" type="text" class="form-control">
                          </td>                               
                        </tr>`;   
                        $('#field-table').append(item); 

                      }

                    }

                    document.ref.collection("designs")
                      .onSnapshot(cardSnapshot => {

                        let cardSize = cardSnapshot.size;            
                        let cardChanges = cardSnapshot.docChanges(); 

                        var alphabet = ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];

                        window.newdesign = alphabet[cardSize];                        
                        
                        if (cardSize > 0) {

                          cardChanges.forEach(cardDoc => {                           

                              let doc = cardDoc.doc;

                              if (doc.exists) {

                                let name = doc.id;
                                let piw = doc.data().public_image_web;
                                let pip = doc.data().public_image_preview;
                                let card = filterCard(name, piw, pip);
                                $("#cards").append(card);   
                                
                                $(`#preview-${name}`).on('click', function() {              
                                  buildLink("preview");
                                }); 

                                $(`#web-${name}`).on('click', function() {       
                                  buildLink("web"); 
                                }); 

                                function buildLink(type) {
                                  let web = "http://localhost:5000/composer/web";
                                  let url = `${web}?&account=${window.account}&type=${type}&campaignId=${campaign_name}&designId=${name}`;            
                                  window.open(url, '_blank');
                                }

                              }

                          });

                        } else {
                          let newCard = getCards("A");                          
                          $("#cards").append(img);
                        }

                    });

                    /**
                     * TODO: Cuando se hace un click en la tabla campaign-table
                     * se debaria seleccionar el row y cargar los diseños que 
                     * deberian ser creados como un array dentro de 
                     * estaba tratando de tomar este modelo se select
                     * https://jsfiddle.net/armaandhir/f04tyoz7/
                     * */ 
                    /*if (count===(size-1)){
                      $('#campaign-table tr').click();
                    }*/
                    //count++;
                  
                });
              }              
          });

          $(".clickable-row").click(function() {
              window.location = $(this).data("href");
          });

        }

        function getNewDesignName(){

        }

        $("#campaign-table tr").click(function(){
          $(this).addClass('selected').siblings().removeClass('selected');    
          var value=$(this).find('td:first').html();
          alert(value);    
        });

        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();        
            if (month.length < 2) 
                month = '0' + month;
            if (day.length < 2) 
                day = '0' + day;        
            return [day, month, year].join('-');
        }

      }); 
      

      $("#add-field").on('click', function() {  
          let item = `<tr id="field${count_field}">
            <td>
              <span class="glyphicon glyphicon-envelope"></span>                                
            </td>
            <td>
              <input id="name_${count_field}" type="text" class="form-control">
            </td>
            <td>
              <input id="value_${count_field}" type="text" class="form-control">
            </td>                               
          </tr>`;   
          $('#field-table').append(item); 
          count_field++;
      });   

      $("#save-campaign").on('click', function() {  

        let _table_size = $("#field-table tbody tr").length;

       var count = 0;
       var fields_array = [];
       var _break = false;
        
        $("#field-table tbody tr").each(function() {
            
          if (_break==false) {  

            let _name = $("#name_" + count ).val();
            let _value = $("#value_" + count ).val(); 
            let _field = {
              "name":_name,
              "value":_value
            };   
            fields_array.push(_field);
            if (count == (_table_size-1)) {
              saveCampaig(fields_array);
              _break = true;
            } 
            count++;
          }

        });

        let card = getCard();          
        $("#cards").append(card);

      });

      function saveCampaig(fields_array) {

        var campaign_name = $("#campaign-name").val();
        var cname = campaign_name.split(' ').join('_');
        var _time =  new Date();

        var uiid;

        var campaign =  db.collection('accounts')
          .doc(window.account)
          .collection("campaigns")
          .doc(cname);

          $("#field-table tbody tr").remove();

          campaign.set({        
            name: campaign_name,
            last_update: _time,      
            time_created: _time,
            fields:fields_array            
          },{ merge:true }).then(docRefSet => {              
            
            return campaign.collection("designs")
                .doc("sample").set({
                  name: "sample",
                  created_date: _time                                         
                },{ merge:true });    
    
          }).then(docRefSet => {
            
            uiid = uuidv4();            
            return db.collection('campaigns')
              .doc(uiid).set({
                campaign_ref: campaign,
                created_date: _time                                         
              });           

          }).then(docRefSet => { 

           return campaign.set({        
            campaign_id: uiid,
            last_update: _time                      
             },{ merge:true });

          }).then(docRefSet => {       

              let _files = document.getElementById("excel-file").files;

              if (_files.length>0) {
                  
                  var storageRef = storage.ref(path);       
                    
                  var filePath =  "jose.xls";        
                  var thisRef = storageRef.child(filePath);    

                  var file = [0]; 
                  var input = this;
                  var length = input.files.length;
                  var _file = input.files.item(0); 
                  
                  var metadataFiles = {
                    customMetadata: {                
                        'type': 'xls',
                        'documentId' : cname,
                        "path" : path                        
                    }
                  };

                  var file = document.getElementById("excel-file").files[0];   
                  var filePathMuseum = "jose.xlsx";        
                  const museumRef = storageRef.child(filePathMuseum);
                  var putRef = museumRef.put(_file, metadataFiles);  

                  putRef.on('state_changed', function(snapshot) {
                      var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                      console.log('Upload is ' + progress + '% done');
                      switch (snapshot.state) {
                        case firebase.storage.TaskState.PAUSED: // or 'paused'
                          console.log('Upload is paused');
                          break;
                        case firebase.storage.TaskState.RUNNING: // or 'running'
                          console.log('Upload is running');
                          break;
                      }
                    }, function(error) {
                      // Handle unsuccessful uploads
                    }, function() { 

                      //Crear                       
                      $('#alertModal').modal('show');                      
                  });

              } else {                

                $('#alert-content').text('La campaña ' + campaign_name + ' ha sido creada con exito.');
                $('#alertModal').modal('show');

              }

            

            
          }).catch((error) => {     
            console.error("Error adding document: ", error);           
          });   


        }

        $("#excel-file").on('change', function() {});

        });  


        function uuidv4() {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
        }


      function filterCard(m, w, p) {        
        if ( ( w!=undefined ) && ( p!=undefined ) ) {         
          return getCard(m, p, w, p);         
        } else {
          if ( w ) {
            return getCardCustom(m, w);              
          }  else if ( p ) {
            return getCardCustom(m, p);              
          }
        }
      }

      function getCard(name) {
        return getCard(name, undefined, undefined);
      }

      function getCardCustom(name, img_preview) {
        return getCard(name, img_preview, undefined);
      }

      function getCardCustom(name, img_web) {
        return getCard(name, undefined, img_web);
      }

      function getCard(name, img_preview, img_web) {
        
        let card = `<div class="col-md-12" style="background-color:#E8F0FE;">                              
              <div class="row col-md-12 mt-3 mb-2">                                
                <div class="col-md-10">
                  <h3 id="card${name}">${name}</h3>                                
                </div>
                <div class="col-md-2">                           
                  <button type="button" class="float-right btn btn-success">X</button>
                </div>
              </div>
              <button id="preview-${name}" class="card border round w-100">`;                                        
              if (img_preview) {
                card += `<img class="w-100" src="${img_preview}"/>`;
              } else {
                card += `<div id="preview-image-${name}" class="card-body">
                          Preview
                        </div>`;
              }
              card += `</button>                                
              <br>
              <button id="web-${name}" class="card border rounded h-100">`;                        
              if (img_web) {
                card += `<img class="w-100" src="${img_web}"/>`;                  
              } else {
                card += `<div id="web-image-${name}" class="card-body">
                                Web Page
                              </div>`;
              }
              card += `</button>
                <div class="row">
                  <div class="col-md-12">
                </div>
                </div>
                <div class="col-md-4">
                </div>
                <div class="col-md-4">
                </div>
              </div>`;            

          return card;
      }

      
      
    </script>  
   
  </body>
</html>
